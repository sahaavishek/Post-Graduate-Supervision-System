// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  SUPERVISOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  WARNING
}

enum MeetingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum MeetingType {
  IN_PERSON
  ONLINE
}

enum DocumentType {
  PDF
  DOCX
  OTHER
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskStatus {
  OPEN
  CLOSED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          UserRole
  status        UserStatus @default(ACTIVE)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  studentProfile Student?
  supervisorProfile Supervisor?

  @@map("users")
}

model Student {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  program             String
  supervisorId        String?
  supervisor          Supervisor? @relation(fields: [supervisorId], references: [id])
  
  startDate           DateTime
  expectedCompletion  DateTime?
  enrollmentDate      DateTime  @default(now())
  overallProgress     Int       @default(0)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  milestones          Milestone[]
  documents           Document[]
  meetings            Meeting[]
  weeklySubmissions   WeeklySubmission[]

  @@map("students")
}

model Supervisor {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  department          String
  maxCapacity         Int       @default(10)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  students            Student[]
  meetings            Meeting[]
  sharedDocuments    Document[]

  @@map("supervisors")
}

model Milestone {
  id                  String            @id @default(cuid())
  studentId           String
  student              Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  name                String
  description         String?
  progress            Int               @default(0)
  status              MilestoneStatus  @default(PENDING)
  dueDate             DateTime?
  completedDate       DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("milestones")
}

model Meeting {
  id                  String            @id @default(cuid())
  studentId           String
  student             Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  supervisorId        String
  supervisor          Supervisor        @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  
  title               String
  agenda              String?
  scheduledDate       DateTime
  duration            Int               // in minutes
  location            String?
  meetingType         MeetingType
  status              MeetingStatus     @default(PENDING)
  meetingLink         String?           // Webex or other meeting link
  recordingUrl        String?
  notes               String?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("meetings")
}

model Document {
  id                  String            @id @default(cuid())
  
  // Document can be uploaded by student or supervisor
  uploadedByStudentId String?
  uploadedBySupervisorId String?
  student             Student?          @relation(fields: [uploadedByStudentId], references: [id], onDelete: Cascade)
  supervisor          Supervisor?       @relation(fields: [uploadedBySupervisorId], references: [id], onDelete: Cascade)
  
  title               String
  description         String?
  fileType            DocumentType
  fileUrl             String
  fileName            String
  fileSize            Int               // in bytes
  
  // For weekly submissions
  weeklySubmissionId  String?
  weeklySubmission    WeeklySubmission? @relation(fields: [weeklySubmissionId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("documents")
}

model WeeklySubmission {
  id                  String            @id @default(cuid())
  studentId           String
  student              Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  week                Int
  title               String
  description         String
  uploadDate          DateTime
  dueDate             DateTime
  taskStatus          TaskStatus       @default(OPEN)
  submissionStatus    SubmissionStatus @default(PENDING)
  submittedFile       String?
  comments            String?
  supervisorFeedback  String?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  documents           Document[]

  @@unique([studentId, week])
  @@map("weekly_submissions")
}

